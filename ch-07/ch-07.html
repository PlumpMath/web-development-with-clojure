<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Chapter 7. Database Access</title>
<style>
@import url(http://fonts.googleapis.com/earlyaccess/nanumgothic.css);
@import url("asciidoctor.css");

html{font-family: 'Nanum Gothic', serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}

body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family: 'Nanum Gothic', serif;;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}

h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#000;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article">
<div id="header">
<h1>Chapter 7. Database Access</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">이 장의 목표</div>
<div class="ulist">
<ul>
<li>
<p>전반부에서는 HugSQL과 clojure.java.jdbc 라이브러리를 이용해 SQL 데이터베이스에 접근하는
법을 배운다. 대부분의 클로저 데이터베이스 라이브러리는 내부적으로 clojure.java.jdbc를
이용한다. 그 중의 하나가 이 장에서 보여줄 HugSQL이다.</p>
</li>
<li>
<p>후반부에서는 서버에서 DB에 담긴 데이터를 꺼내 와 간단한 pdf 파일을 만든 후에, 이것을
클라이언트로 전송하는 예를 보여준다.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_postgresql">1. PostgreSQL</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_postgresql_설치_on_ubuntu">1.1. PostgreSQL 설치 (on Ubuntu)</h3>
<div class="listingblock">
<div class="content">
<pre>$ sudo apt-get install postgresql

$ sudo -u postgres psql
psql (9.4.5)
Type "help" for help.

postgres=# help
You are using psql, the command-line interface to PostgreSQL.
Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | ko_KR.UTF-8 | ko_KR.UTF-8 |
 template0 | postgres | UTF8     | ko_KR.UTF-8 | ko_KR.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | ko_KR.UTF-8 | ko_KR.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(3 rows)

postgres=# \q

$</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_postgresql_패스워드_설정">1.2. PostgreSQL 패스워드 설정</h3>
<div class="listingblock">
<div class="content">
<pre>$ sudo -u postgres psql postgres

postgres=# \password postgres
Enter new password:
Enter it again:</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_user_및_database_생성">1.3. User 및 Database 생성</h3>
<div class="listingblock">
<div class="content">
<pre>$ sudo -u postgres psql postgres

postgres=# CREATE USER admin WITH PASSWORD 'admin';
CREATE ROLE

postgres=# CREATE DATABASE REPORTING OWNER admin;
CREATE DATABASE

postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | ko_KR.UTF-8 | ko_KR.UTF-8 |
 reporting | admin    | UTF8     | ko_KR.UTF-8 | ko_KR.UTF-8 |
 template0 | postgres | UTF8     | ko_KR.UTF-8 | ko_KR.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | ko_KR.UTF-8 | ko_KR.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(4 rows)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_accessing_the_database_with_clojure_java_jdbc">2. Accessing the Database with clojure.java.jdbc</h2>
<div class="sectionbody">
<div class="paragraph">
<p>먼저 leinngen을 이용해 db-examples 프로젝트를 생성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ lein new db-examples</pre>
</div>
</div>
<div class="listingblock">
<div class="title">db-examples/project.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject db-examples <span class="string"><span class="delimiter">&quot;</span><span class="content">0.1.0-SNAPSHOT</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:dependencies</span> [[org.clojure/clojure <span class="string"><span class="delimiter">&quot;</span><span class="content">1.8.0</span><span class="delimiter">&quot;</span></span>]
                 [org.clojure/java.jdbc <span class="string"><span class="delimiter">&quot;</span><span class="content">0.4.2</span><span class="delimiter">&quot;</span></span>]                 <span class="comment">; </span><i class="conum" data-value="1"></i><b>(1)</b>
                 [org.postgresql/postgresql <span class="string"><span class="delimiter">&quot;</span><span class="content">9.4-1201-jdbc41</span><span class="delimiter">&quot;</span></span>]   <span class="comment">; </span><i class="conum" data-value="2"></i><b>(2)</b>
                 [com.layerware/hugsql <span class="string"><span class="delimiter">&quot;</span><span class="content">0.4.1</span><span class="delimiter">&quot;</span></span>]])</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_database_connection_map_만들기">2.1. Database connection map 만들기</h3>
<div class="listingblock">
<div class="title">src/db_examples/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">db-examples.core</span>
  (<span class="symbol">:require</span> [clojure.java.jdbc <span class="symbol">:as</span> sql]))

<span class="comment">;; db connection map</span>
(<span class="keyword">def</span> <span class="function">db</span> {<span class="symbol">:subprotocol</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">postgresql</span><span class="delimiter">&quot;</span></span>
         <span class="symbol">:subname</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">//localhost/reporting</span><span class="delimiter">&quot;</span></span>
         <span class="symbol">:user</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>
         <span class="symbol">:password</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>})</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_테이블_생성하기">2.2. 테이블 생성하기</h3>
<div class="listingblock">
<div class="title">src/db_examples/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">create-users-table!</span> []
  (sql/db-do-commands db
    (sql/create-table-ddl
      <span class="symbol">:users</span>
      [<span class="symbol">:id</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">varchar(32) PRIMARY KEY</span><span class="delimiter">&quot;</span></span>]
      [<span class="symbol">:pass</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">varchar(100)</span><span class="delimiter">&quot;</span></span>])))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>(create-users-table!)
; =&gt; (0)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">DDL(Data Definition Language)</dt>
<dd>
<p>데이터베이스의 스키마 객체를 생성(CREATE), 변경(ALTER),
제거(DROP) 하거나 권한의 부여나 박탈(GRANT, REVOKE), 주석(COMMENT), 자료의
버림(TRUNCATE) 등을 수행하는 문장의 집단을 의미한다. 각 문장은 CREATE, ALTER, DROP,
TRUNCATE, GRANT, REVOKE, COMMENT 등으로 시작한다.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_creating_recoords">2.3. Creating Recoords</h3>
<div class="listingblock">
<div class="title">src/db_examples/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">add-user!</span> [user]
  (sql/insert! db <span class="symbol">:users</span> user))

(<span class="keyword">defn</span> <span class="function">add-users!</span> [&amp; users]
  (<span class="keyword">apply</span> sql/insert! db <span class="symbol">:users</span> users))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>(add-user! {:id "foo" :pass "bar"})
; =&gt; ({:id "foo", :pass "bar"})

(get-user "foo")
; =&gt; {:id "foo", :pass "bar"}

(add-users!
  {:id "foo1" :pass "bar1"}
  {:id "foo2" :pass "bar2"}
  {:id "foo3" :pass "bar3"})
; =&gt; ({:id "foo1", :pass "bar1"}
;     {:id "foo2", :pass "bar2"}
;     {:id "foo3", :pass "bar3"})

(get-all-users)
; =&gt; ({:id "foo", :pass "bar"}
;     {:id "foo1", :pass "bar1"}
;     {:id "foo2", :pass "bar2"}
;     {:id "foo3", :pass "bar3"})

;; 위의 add-users! 함수 대신 다음과 같이 실행해도 같은 결과를 얻는다.
; (sql/insert! db :users [:id :pass]
;                        ["foo1" "bar1"]
;                        ["foo2" "bar2"]
;                        ["foo3" "bar3"])</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_records">2.4. Reading Records</h3>
<div class="listingblock">
<div class="title">src/db_examples/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">get-user</span> [id]
  (<span class="keyword">first</span> (sql/query db [<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from users where id = ?</span><span class="delimiter">&quot;</span></span> id])))

(<span class="keyword">defn</span> <span class="function">get-all-users</span> []
  (sql/query db [<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from users</span><span class="delimiter">&quot;</span></span>]))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_records">2.5. Updating Records</h3>
<div class="listingblock">
<div class="title">src/db_examples/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">set-pass!</span> [id pass]
  (sql/update!
   db
   <span class="symbol">:users</span>
   {<span class="symbol">:pass</span> pass}
   [<span class="string"><span class="delimiter">&quot;</span><span class="content">id=?</span><span class="delimiter">&quot;</span></span> id]))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>(set-pass! "foo" "baz")
; =&gt; (1)

(get-user "foo")
; =&gt; {:id "foo", :pass "baz"}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_records">2.6. Deleting Records</h3>
<div class="listingblock">
<div class="title">src/db_examples/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">remove-user!</span> [id]
  (sql/delete! db <span class="symbol">:users</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">id=?</span><span class="delimiter">&quot;</span></span> id]))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>(remove-user! "foo")
; =&gt; (1)

(get-all-users)
; =&gt; ({:id "foo1", :pass "bar1"}
;     {:id "foo2", :pass "bar2"}
;     {:id "foo3", :pass "bar3"})</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transactions">2.7. Transactions</h3>
<div class="listingblock">
<div class="title">src/db_examples/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(sql/with-db-transaction [t-conn db]
  (sql/update!
    t-conn
    <span class="symbol">:users</span>
    {<span class="symbol">:pass</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">baz1</span><span class="delimiter">&quot;</span></span>}
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">id=?</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">foo1</span><span class="delimiter">&quot;</span></span>])
  (sql/update!
    t-conn
    <span class="symbol">:users</span>
    {<span class="symbol">:pass</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">baz2</span><span class="delimiter">&quot;</span></span>}
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">id=?</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">foo2</span><span class="delimiter">&quot;</span></span>]))
<span class="comment">; =&gt; (1)</span>

(get-all-users)
<span class="comment">; =&gt; ({:id &quot;foo1&quot;, :pass &quot;baz1&quot;}</span>
<span class="comment">;     {:id &quot;foo2&quot;, :pass &quot;baz2&quot;}</span>
<span class="comment">;     {:id &quot;foo3&quot;, :pass &quot;bar3&quot;})</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_hugsql">3. Use HugSQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>HugSQL은 SQL query문과 클로저 코드를 서로 다른 파일에 분리한 후, 이 둘을 <code>def-db-fns</code>
매크로를 통해 데이터베이스 처리 함수를 컴파일 타임에 생성한다.</p>
</div>
<div class="sect2">
<h3 id="_사용_예">3.1. 사용 예</h3>
<div class="listingblock">
<div class="title">users.sql</div>
<div class="content">
<pre>-- :name add-user!
-- :command :execute
-- :result :affected
-- :doc  adds a new user
INSERT INTO users
  (id, pass)
  VALUES (:id, :pass)</pre>
</div>
</div>
<div class="paragraph">
<p>다음은 위의 내용을 간결하게 표현한 것으로 서로 등가이다. 즉, <code>:name &lt;function-name&gt;
&lt;command-flag&gt; &lt;result-flag&gt;</code>과 같은 방식으로 한 줄로 줄여 쓸 수 있다.</p>
</div>
<div class="listingblock">
<div class="title">resources/users.sql</div>
<div class="content">
<pre>-- :name add-user! :! :n
-- :doc  adds a new user
INSERT INTO users
  (id, pass)
  VALUES (:id, :pass)</pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/db_examples/hugsql.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">db-examples.hugsql</span>
    (<span class="symbol">:require</span> [db-examples.core <span class="symbol">:refer</span> [db]]
              [clojure.java.jdbc <span class="symbol">:as</span> sql]
              [hugsql.core <span class="symbol">:as</span> hugsql]))

<span class="comment">;; users.sql 파일은 class-path에 지정된 경로를 탐색해 찾는다.</span>
(hugsql/def-db-fns <span class="string"><span class="delimiter">&quot;</span><span class="content">users.sql</span><span class="delimiter">&quot;</span></span>)

(add-user! db {<span class="symbol">:id</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">apple</span><span class="delimiter">&quot;</span></span> <span class="symbol">:pass</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">delicious</span><span class="delimiter">&quot;</span></span>})
<span class="comment">; =&gt; 1</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_command_flags">3.2. Command Flags</h3>
<div class="ulist">
<ul>
<li>
<p>:query or :? — indicates a query with a result set</p>
</li>
<li>
<p>:execute or :! — can be used for any statement</p>
</li>
<li>
<p>:returning-execute or :&lt;! — used to indicate an INSERT &#8230;&#8203; RETURNING query</p>
</li>
<li>
<p>:insert or :i! — will attempt to return the generated keys</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_result_flags">3.3. Result Flags</h3>
<div class="ulist">
<ul>
<li>
<p>:one or :1 — a result with a single row</p>
</li>
<li>
<p>:many or :* — a result with multiple rows</p>
</li>
<li>
<p>:affected or :n — the number of affected rows</p>
</li>
<li>
<p>:raw — returns the result generated by the underlying database adapter</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_insert_returning">3.4. INSERT &#8230;&#8203; returning</h3>
<div class="listingblock">
<div class="title">resources/users.sql</div>
<div class="content">
<pre>-- :name add-user-returning! :i :1
-- :doc  adds a new user returning the id
INSERT INTO users
  (id, pass)
  VALUES (:id, :pass)
  returning id</pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/db_examples/hugsql.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(add-user-returning! db {<span class="symbol">:id</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">banana</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:pass</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">tasty</span><span class="delimiter">&quot;</span></span>})
<span class="comment">; =&gt; {:id &quot;banana&quot;}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_t_code_tuple_list">3.5. <code>:t*</code> (tuple list)</h3>
<div class="listingblock">
<div class="title">resources/users.sql</div>
<div class="content">
<pre>-- :name add-users! :! :n
-- :doc add multiple users
INSERT INTO users
  (id, pass)
  VALUES :t*:users</pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/db_examples/hugsql.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(add-users! db {<span class="symbol">:users</span>
                [[<span class="string"><span class="delimiter">&quot;</span><span class="content">bob</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>]
                 [<span class="string"><span class="delimiter">&quot;</span><span class="content">alice</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>]]})
<span class="comment">; =&gt; 2</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_v_code_in_list_queries">3.6. <code>:v*</code> (in-list queries)</h3>
<div class="listingblock">
<div class="title">resources/users.sql</div>
<div class="content">
<pre>-- :name find-users :? :*
-- find users with a matching ID
SELECT *
  FROM users
  WHERE id IN (:v*:ids)</pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/db_examples/hugsql.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(find-users db {<span class="symbol">:ids</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">baz</span><span class="delimiter">&quot;</span></span>]})
<span class="comment">; =&gt; ({:id &quot;bob&quot;, :pass &quot;Bob&quot;}</span>
<span class="comment">;     {:id &quot;alice&quot;, :pass &quot;Alice&quot;})</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transaction">3.7. Transaction</h3>
<div class="listingblock">
<div class="title">src/db_examples/hugsql.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">add-user-transaction</span> [user]
  (sql/with-db-transaction [t-conn db]
    (<span class="keyword">if-not</span> (find-user t-conn {<span class="symbol">:id</span> (<span class="symbol">:id</span> user)})
       (add-user! t-conn user))))

(add-user-transaction {<span class="symbol">:id</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">foobar</span><span class="delimiter">&quot;</span></span>
                       <span class="symbol">:pass</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">I'm transactional</span><span class="delimiter">&quot;</span></span>})
<span class="comment">; =&gt; 1</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generate_reports">4. Generate Reports</h2>
<div class="sectionbody">
<div class="paragraph">
<p>clj-pdf 라이브러리를 이용해 동적으로 pdf를 서버에서 만든 후에, 클라이언트의 요청에 따라
pdf를 제공하는 프로젝트의 예를 보여 준다.</p>
</div>
<div class="sect2">
<h3 id="_프로젝트_만들기">4.1. 프로젝트 만들기</h3>
<div class="paragraph">
<p>먼저 lein으로 reporting-example이라는 프로젝트를 만든다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>lein new luminus reporting-example +postgres</pre>
</div>
</div>
<div class="paragraph">
<p>project.clj의 :depedencies에 다음을 추가한다.</p>
</div>
<div class="listingblock">
<div class="title">project.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject reporting-example <span class="string"><span class="delimiter">&quot;</span><span class="content">0.1.0-SNAPSHOT</span><span class="delimiter">&quot;</span></span>
  ,,,,,,
  <span class="symbol">:dependencies</span> [,,,,,,
                 [clj-pdf <span class="string"><span class="delimiter">&quot;</span><span class="content">2.2.0</span><span class="delimiter">&quot;</span></span>]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>profiles.clj 파일을 다음과 같은 내용으로 만든다.</p>
</div>
<div class="listingblock">
<div class="title">profiles.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:profiles/dev</span>
 {<span class="symbol">:env</span>
  {<span class="symbol">:database-url</span>
   <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:postgresql://localhost/reporting?user=admin&amp;password=admin</span><span class="delimiter">&quot;</span></span>}}
 <span class="symbol">:profiles/test</span>
 {<span class="symbol">:env</span>
  {<span class="symbol">:database-url</span>
   <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:postgresql://localhost/report_test?user=admin&amp;password=admin</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_migration_파일_만들기">4.2. migration 파일 만들기</h3>
<div class="listingblock">
<div class="title">resources/migrations/201504171229-add-users-table.up.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">CREATE TABLE employee
  (<span class="keyword">name</span> VARCHAR(<span class="integer">50</span>),
   occupation VARCHAR(<span class="integer">50</span>),
   place VARCHAR(<span class="integer">50</span>),
   country VARCHAR(<span class="integer">50</span>))<span class="comment">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">resources/migrations/201504171229-add-users-table.down.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">DROP TABLE employee<span class="comment">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>다음과 같이 실행해 employee 테이블을 만든다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ lein run migrate</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_serializing_and_deserializing_data_based_on_its_type">4.3. Serializing and Deserializing Data Based on Its Type</h3>
<div class="listingblock">
<div class="content">
<pre>                               serialize
Clojure/Java Data Types  --------------------&gt;  SQL Data Types
                         &lt;--------------------
                              deserialize</pre>
</div>
</div>
<div class="sect3">
<h4 id="_serializing">4.3.1. Serializing</h4>
<div class="listingblock">
<div class="title">src/clj/reporting_example/db/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">reporting-example.db.core</span>
  (<span class="symbol">:require</span>
    [cheshire.core <span class="symbol">:refer</span> [generate-string parse-string]]
    [clojure.java.jdbc <span class="symbol">:as</span> jdbc]
    [conman.core <span class="symbol">:as</span> conman]
    [config.core <span class="symbol">:refer</span> [env]]
    [mount.core <span class="symbol">:refer</span> [defstate]])
  (<span class="symbol">:import</span> org.postgresql.util.PGobject
           org.postgresql.jdbc4.Jdbc4Array
           clojure.lang.IPersistentMap
           clojure.lang.IPersistentVector
           [java.sql
            BatchUpdateException
            Date
            Timestamp
            PreparedStatement]))

,,,,,,
(<span class="keyword">extend-type</span> java.util.Date
  jdbc/ISQLParameter
  (set-parameter [v ^PreparedStatement stmt idx]
    (<span class="keyword">.</span>setTimestamp stmt idx (Timestamp. (<span class="keyword">.</span>getTime v)))))

(<span class="keyword">defn</span> <span class="function">to-pg-json</span> [value]
  (<span class="keyword">doto</span> (PGobject.)
    (<span class="keyword">.</span>setType <span class="string"><span class="delimiter">&quot;</span><span class="content">jsonb</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">.</span>setValue (generate-string value))))

(<span class="keyword">extend-protocol</span> jdbc/ISQLValue
  IPersistentMap
  (sql-value [value] (to-pg-json value))
  IPersistentVector
  (sql-value [value] (to-pg-json value)))</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/clojure/java.jdbc/blob/master/src/main/clojure/clojure/java/jdbc.clj#L314">jdbc/ISQLValue</a></p>
</li>
<li>
<p><a href="https://github.com/clojure/java.jdbc/blob/master/src/main/clojure/clojure/java/jdbc.clj#L328">jdbc/ISQLParameter</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_deerializing">4.3.2. Deerializing</h4>
<div class="listingblock">
<div class="title">src/clj/reporting_example/db/core.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">,,,,,,
(<span class="keyword">defn</span> <span class="function">to-date</span> [sql-date]
  (<span class="keyword">-&gt;</span> sql-date (<span class="keyword">.</span>getTime) (java.util.Date.)))

(<span class="keyword">extend-protocol</span> jdbc/IResultSetReadColumn
  Date
  (result-set-read-column [v _ _] (to-date v))

  Timestamp
  (result-set-read-column [v _ _] (to-date v))

  Jdbc4Array
  (result-set-read-column [v _ _] (<span class="keyword">vec</span> (<span class="keyword">.</span>getArray v)))

  PGobject
  (result-set-read-column [pgobj _metadata _index]
    (<span class="keyword">let</span> [<span class="keyword">type</span>  (<span class="keyword">.</span>getType pgobj)
          value (<span class="keyword">.</span>getValue pgobj)]
      (<span class="keyword">case</span> <span class="keyword">type</span>
        <span class="string"><span class="delimiter">&quot;</span><span class="content">json</span><span class="delimiter">&quot;</span></span> (parse-string value <span class="predefined-constant">true</span>)
        <span class="string"><span class="delimiter">&quot;</span><span class="content">jsonb</span><span class="delimiter">&quot;</span></span> (parse-string value <span class="predefined-constant">true</span>)
        <span class="string"><span class="delimiter">&quot;</span><span class="content">citext</span><span class="delimiter">&quot;</span></span> (<span class="keyword">str</span> value)
        value))))</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/clojure/java.jdbc/blob/master/src/main/clojure/clojure/java/jdbc.clj#L347">jdbc/IResultSetReadColumn</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_employee_테이블에_데이터_입력하기">4.4. employee 테이블에 데이터  입력하기</h3>
<div class="paragraph">
<p>REPL 상에서 다음을 직접 실행해, 데이터를 직접 입력해 준다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(mount.core/start <span class="error">#</span>'reporting-example.db.core/*db*)

(<span class="keyword">in-ns</span> 'reporting-example.db.core)

(jdbc/insert!
 *db*
 <span class="symbol">:employee</span>
 [<span class="symbol">:name</span> <span class="symbol">:occupation</span> <span class="symbol">:place</span> <span class="symbol">:country</span>]
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">Albert Einstein</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Engineer</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Ulm</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Germany</span><span class="delimiter">&quot;</span></span>]
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">Alfred Hitchcock</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Movie Director</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">London</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">UK</span><span class="delimiter">&quot;</span></span>]
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">Wernher Von Braun</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Rocket Scientist</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Wyrzysk</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Poland</span><span class="delimiter">&quot;</span></span>]
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">Sigmund Freud</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Neurologist</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Pribor</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Czech Republic</span><span class="delimiter">&quot;</span></span>]
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">Mahatma Gandhi</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Lawyer</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Gujarat</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">India</span><span class="delimiter">&quot;</span></span>]
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">Sachin Tendulkar</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Cricket Player</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Mumbai</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">India</span><span class="delimiter">&quot;</span></span>]
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">Michael Schumacher</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">F1 Racer</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Cologne</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Germany</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_쿼리문_작성하기">4.5. 쿼리문 작성하기</h3>
<div class="listingblock">
<div class="title">resources/sql/queries.sql</div>
<div class="content">
<pre>-- :name read-employees :? :*
-- reads the list of employees
select * from employee</pre>
</div>
</div>
<div class="paragraph">
<p>REPL 상에서 태스트해 본다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(conman/bind-connection *db* <span class="string"><span class="delimiter">&quot;</span><span class="content">sql/queries.sql</span><span class="delimiter">&quot;</span></span>)

(read-employees)
<span class="comment">; =&gt; ({:country &quot;Germany&quot;,</span>
<span class="comment">;      :place &quot;Ulm&quot;,</span>
<span class="comment">;      :occupation &quot;Engineer&quot;,</span>
<span class="comment">;      :name &quot;Albert Einstein&quot;}</span>
<span class="comment">;     {:country &quot;UK&quot;,</span>
<span class="comment">;      :place &quot;London&quot;,</span>
<span class="comment">;      :occupation &quot;Movie Director&quot;,</span>
<span class="comment">;      :name &quot;Alfred Hitchcock&quot;}</span>
<span class="comment">;     ...)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generating_the_reports">4.6. Generating the Reports</h3>
<div class="sect3">
<h4 id="_doc_pdf_만들기">4.6.1. doc.pdf 만들기</h4>
<div class="listingblock">
<div class="title">src/clj/reporting_example/reports.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">reporting-example.reports</span>
  (<span class="symbol">:require</span> [reporting-example.db.core <span class="symbol">:as</span> db]
            [clj-pdf.core <span class="symbol">:refer</span> [pdf template]]))

(pdf
 [{<span class="symbol">:header</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Wow that was easy</span><span class="delimiter">&quot;</span></span>}
  [<span class="symbol">:list</span>
    [<span class="symbol">:chunk</span> {<span class="symbol">:style</span> <span class="symbol">:bold</span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">a bold item</span><span class="delimiter">&quot;</span></span>]
    <span class="string"><span class="delimiter">&quot;</span><span class="content">another item</span><span class="delimiter">&quot;</span></span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">yet another item</span><span class="delimiter">&quot;</span></span>]
  [<span class="symbol">:paragraph</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">I'm a paragraph!</span><span class="delimiter">&quot;</span></span>]]
 <span class="string"><span class="delimiter">&quot;</span><span class="content">doc.pdf</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_table_doc_pdf_만들기">4.6.2. table-doc.pdf 만들기</h4>
<div class="listingblock">
<div class="title">src/clj/reporting_example/reports.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(pdf
 [{<span class="symbol">:header</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Employee List</span><span class="delimiter">&quot;</span></span>}
  (<span class="keyword">into</span> [<span class="symbol">:table</span>
         {<span class="symbol">:border</span> <span class="predefined-constant">false</span>
          <span class="symbol">:cell-border</span> <span class="predefined-constant">false</span>
          <span class="symbol">:header</span> [{<span class="symbol">:backdrop-color</span> [<span class="integer">0</span> <span class="integer">150</span> <span class="integer">150</span>]} <span class="string"><span class="delimiter">&quot;</span><span class="content">Name</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Occupation</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Place</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Country</span><span class="delimiter">&quot;</span></span>]}]
        (employee-template (db/read-employees)))]
   <span class="string"><span class="delimiter">&quot;</span><span class="content">table-report.pdf</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_list_doc_pdf_만들기">4.6.3. list-doc.pdf 만들기</h4>
<div class="listingblock">
<div class="title">clj-pdf의 <code>template</code> 함수 이용 예</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">employee-template</span>
  (template [$name $occupation $place $country]))

(employee-template (<span class="keyword">take</span> <span class="integer">2</span> (db/read-employees)))
<span class="comment">;=&gt; ([&quot;Albert Einstein&quot; &quot;Engineer&quot; &quot;Ulm&quot; &quot;Germany&quot;]</span>
<span class="comment">;    [&quot;Alfred Hitchcock&quot;, &quot;Movie Director&quot;, &quot;London&quot;, &quot;UK&quot;])</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/clj/reporting_example/reports.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">employee-template-paragraph</span>
  (template
   [<span class="symbol">:paragraph</span>
     [<span class="symbol">:heading</span> {<span class="symbol">:style</span> {<span class="symbol">:size</span> <span class="integer">15</span>}} $name]
     [<span class="symbol">:chunk</span> {<span class="symbol">:style</span> <span class="symbol">:bold</span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">occupation: </span><span class="delimiter">&quot;</span></span>] $occupation <span class="string"><span class="delimiter">&quot;</span><span class="content">\n</span><span class="delimiter">&quot;</span></span>
     [<span class="symbol">:chunk</span> {<span class="symbol">:style</span> <span class="symbol">:bold</span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">place: </span><span class="delimiter">&quot;</span></span>] $place <span class="string"><span class="delimiter">&quot;</span><span class="content">\n</span><span class="delimiter">&quot;</span></span>
     [<span class="symbol">:chunk</span> {<span class="symbol">:style</span> <span class="symbol">:bold</span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">country: </span><span class="delimiter">&quot;</span></span>] $country
     [<span class="symbol">:spacer</span>]]))

(pdf
  [{}
   [<span class="symbol">:heading</span> {<span class="symbol">:size</span> <span class="integer">10</span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">Employees</span><span class="delimiter">&quot;</span></span>]
   [<span class="symbol">:line</span>]
   [<span class="symbol">:spacer</span>]
   (employee-template-paragraph (db/read-employees))]
 <span class="string"><span class="delimiter">&quot;</span><span class="content">list-report.pdf</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_displaying_the_reports">4.7. Displaying the Reports</h3>
<div class="listingblock">
<div class="title">resources/templates/home.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{% extends <span class="string"><span class="delimiter">&quot;</span><span class="content">base.html</span><span class="delimiter">&quot;</span></span> %}
{% block content %}
  &lt;div <span class="keyword">class</span><span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="keyword">&gt;</span>
    &lt;div <span class="keyword">class</span><span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">span12</span><span class="delimiter">&quot;</span></span><span class="keyword">&gt;</span>
        &lt;h1&gt;Select report <span class="keyword">type</span><span class="symbol">:&lt;/h1&gt;</span>
        &lt;ul <span class="keyword">class</span><span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">nav nav-pills</span><span class="delimiter">&quot;</span></span><span class="keyword">&gt;</span>
            &lt;li <span class="keyword">class</span><span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-default</span><span class="delimiter">&quot;</span></span><span class="keyword">&gt;</span>
                &lt;a href<span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">{{servlet-context}}/list</span><span class="delimiter">&quot;</span></span>&gt;List reports&lt;/a&gt;
            &lt;/li&gt;
            &lt;li <span class="keyword">class</span><span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-default</span><span class="delimiter">&quot;</span></span><span class="keyword">&gt;</span>
                &lt;a href<span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">{{servlet-context}}/table</span><span class="delimiter">&quot;</span></span>&gt;Table reports&lt;/a&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
        {% <span class="keyword">if</span> error %}
        &lt;h2&gt;An error has occured <span class="keyword">while</span> generating the report<span class="symbol">:&lt;/h2&gt;</span>
        &lt;div <span class="keyword">class</span><span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">alert alert-danger</span><span class="delimiter">&quot;</span></span><span class="keyword">&gt;</span>{{error}}&lt;/div&gt;
        {% endif %}
    &lt;/div&gt;
  &lt;/div&gt;
{% endblock %}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/clj/reporting_example/routes/home.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">reporting-example.routes.home</span>
  (<span class="symbol">:require</span> [ring.util.response <span class="symbol">:as</span> response]
            [compojure.core <span class="symbol">:refer</span> [defroutes GET]]
            [reporting-example.reports <span class="symbol">:as</span> reports]
            [reporting-example.layout <span class="symbol">:as</span> layout]))

(<span class="keyword">defn</span> <span class="function">home-page</span> []
  (layout/render <span class="string"><span class="delimiter">&quot;</span><span class="content">home.html</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> <span class="function">about-page</span> []
  (layout/render <span class="string"><span class="delimiter">&quot;</span><span class="content">about.html</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> <span class="function">write-response</span> [report-bytes]
  (<span class="keyword">with-open</span> [in (java.io.ByteArrayInputStream. report-bytes)]
    (<span class="keyword">-&gt;</span> (response/response in)
        (response/header <span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Disposition</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">filename=document.pdf</span><span class="delimiter">&quot;</span></span>)
        (response/header <span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Length</span><span class="delimiter">&quot;</span></span> (<span class="keyword">count</span> report-bytes))
        (response/content-type <span class="string"><span class="delimiter">&quot;</span><span class="content">application/pdf</span><span class="delimiter">&quot;</span></span>)) ))

(<span class="keyword">defn</span> <span class="function">generate-report</span> [report-type]
  (<span class="keyword">try</span>
    (<span class="keyword">let</span> [out (java.io.ByteArrayOutputStream.)]
      (<span class="keyword">condp</span> <span class="keyword">=</span> (<span class="keyword">keyword</span> report-type)
        <span class="symbol">:table</span> (reports/table-report out)
        <span class="symbol">:list</span>  (reports/list-report out))
      (write-response (<span class="keyword">.</span>toByteArray out)))

    (<span class="keyword">catch</span> Exception ex
      (layout/render <span class="string"><span class="delimiter">&quot;</span><span class="content">home.html</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:error</span> (<span class="keyword">.</span>getMessage ex)}))))

(defroutes home-routes
  (GET <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> [] (home-page))
  (GET <span class="string"><span class="delimiter">&quot;</span><span class="content">/about</span><span class="delimiter">&quot;</span></span> [] (about-page))
  (GET <span class="string"><span class="delimiter">&quot;</span><span class="content">/:report-type</span><span class="delimiter">&quot;</span></span> [report-type] (generate-report report-type)))</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-03-26 11:37:32 KST
</div>
</div>
</body>
</html>